{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="text-gray-400 bg-gray-900 body-font min-h-screen">
    <div class="container px-5 py-24 mx-auto flex flex-wrap items-center">
      <div class="lg:w-3/5 md:w-1/2 md:pr-16 lg:pr-0 pr-0">
        <img class="object-cover object-center rounded" alt="hero" id="hero" src="{% static "assets/image.jpeg" %}">
        <div class="flex h-[50px] justify-around item-center my-4">
        <p class="mt-[25px] pl-[30px] text-white" id="route">The route will come here</p>
            <img id='soundBtn' class="w-7" onclick="toggleImage()" src="{% static "assets/mic.png" %}" alt="">
        </div>
      </div>
      <div class="lg:w-2/6 md:w-1/2 bg-gray-800 bg-opacity-50 rounded-lg p-8 flex flex-col md:ml-auto w-full mt-10 md:mt-0">
        <h2 class="text-white text-lg font-medium title-font mb-5">Enter From and To <span class="text-[red]" id="commonwarn"></span></h2> 
        <div class="relative mb-4">
            <form >
          <label for="from" class="leading-7 text-sm text-gray-400">From</label> <span id="fromwarn" class="text-[red]"></span>
          <input type="text" id="from"  name="from" autocomplete="off" class="w-full bg-gray-600 bg-opacity-20 focus:bg-transparent focus:ring-2 focus:ring-blue-900 rounded border border-gray-600 focus:border-blue-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"> 
        </div>
        <div class="relative mb-4">
          <label for="to" class="leading-7 text-sm text-gray-400">To</label> <span id="towarn" class="text-[red]"></span>
          <input type="text" id="to"  name="to" autocomplete="off" class="w-full bg-gray-600 bg-opacity-20 focus:bg-transparent focus:ring-2 focus:ring-blue-900 rounded border border-gray-600 focus:border-blue-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
        </div>
        <button id="subBtn" class="text-white bg-blue-500 border-0 py-2 px-8 focus:outline-none hover:bg-blue-600 rounded text-lg">Button</button>
    </form>
      </div>
    </div>
  </section>

{% endblock content %}

{% block scripts %}

<script>
    let soundBtn = document.getElementById('soundBtn')

    async function fetchImage(fromValue, toValue) {
    try {
        const response = await fetch(`get-route?start_node_name=${fromValue.toUpperCase()}&end_node_name=${toValue.toUpperCase()}`);
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        const data = await response.json();
        
        // Assuming the JSON response contains the image_base64 field
        return data;
    } catch (error) {
        throw new Error("Error fetching image:", error);
    }
}
let currentUtterance = null; // Variable to store the current utterance

// Function to speak the provided text
function speak(text, speed = 1, voice =  null) {
    const speechSynthesis = window.speechSynthesis;
    if (speechSynthesis) {
        // Cancel any ongoing speech
        cancelSpeech();

        // Create a new utterance and set rate
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = speed; // Adjust speech speed
        
        // Set voice if specified
        if (voice) {
            const voices = speechSynthesis.getVoices();
            const selectedVoice = voices.find(v => v.name === voice);
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                console.error(`Voice "${voice}" not found.`);
            }
        }

        utterance.onend = () => {
             soundBtn.src = '{% static "assets/mic.png" %}';
             // soundBtn.style.width="25px"
            soundBtn.classList.remove('w-12')
            soundBtn.classList.add('w-7')
        };
        speechSynthesis.speak(utterance);
    } else {
        console.error("Speech synthesis not supported by the browser.");
    }
}
// Function to cancel ongoing speech
function cancelSpeech() {
    const speechSynthesis = window.speechSynthesis;
    if (speechSynthesis && currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
    }
}

    let from = document.getElementById('from');
    let to = document.getElementById('to'); 
    let subBtn = document.getElementById('subBtn');
    let hero = document.getElementById('hero')
    let sound = "No Data Available"
  
    let commonwarn = document.getElementById('commonwarn');
    let regex = /^\d+$/; 

    subBtn.onclick = async (e)=>{
        e.preventDefault();
        if (from.value == "" || to.value == "" ){
            commonwarn.innerHTML = "  **Please Fill The Form"
            setTimeout(function() {
        commonwarn.innerHTML = "";
    }, 3000); 
        }
        // else if (regex.test(from.value) || !regex.test(to.value)){
            
    //         commonwarn.innerHTML = "  **Characters only allowed"
    //         setTimeout(function() {
    //     commonwarn.innerHTML = "";
    // }, 3000); 
    //     }
        else{
            try {
            let data = await fetchImage(from.value, to.value);
            console.log(data);

            // Assuming the JSON response contains the image_base64 field
            // let imgBase64 = data.image_base64;
            hero.src = await `static/navigation_images/${data.image_filename}`
            sound = ""
            sound = data.directions.join(" then ")
            route.innerHTML = sound
            // // Set the src attribute of the img tag to the Base64 encoded image data
            // hero.src = imgBase64;
        } catch (error) {
            console.error("Error fetching image:", error);
        }
        }

    }


    function toggleImage() {
        let soundBtn = document.getElementById('soundBtn')
        if (soundBtn.src.endsWith('mic.png')) {
            soundBtn.src = '{% static "assets/sound.gif" %}'; // Change to the second image
            speak(sound)
            // soundBtn.style.width="40px"
            soundBtn.classList.remove('w-7')
            soundBtn.classList.add('w-12')
        } else {
            soundBtn.src = '{% static "assets/mic.png" %}'; // Change back to the first image
            // soundBtn.style.width="25px"
            soundBtn.classList.remove('w-12')
            soundBtn.classList.add('w-7')
            cancelSpeech()
        }
    }


</script>
{% endblock scripts %}